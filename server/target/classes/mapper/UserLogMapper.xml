<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.an.mapper.UserLogMapper">
    <!-- 插入日志 -->
    <insert id="insert" parameterType="com.an.entity.UserLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_logs(user_id, action_type, target_id, ip_address, created_at)
        VALUES (#{userId}, #{actionType}, #{targetId}, #{ipAddress}, #{createdAt})
    </insert>

    <!-- 查询日志列表 -->
    <select id="list" resultType="com.an.entity.UserLog">
        SELECT *
        FROM user_logs
        WHERE 1 = 1
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="actionType != null">
            AND action_type = #{actionType}
        </if>
        <if test="startTime != null">
            AND created_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_at &lt;= #{endTime}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 查询最近 N 条日志 -->
    <select id="recent" resultType="com.an.entity.UserLog">
        SELECT *
        FROM user_logs
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <select id="pageQuery" resultType="com.an.entity.UserLog">
        SELECT *
        FROM user_logs
        WHERE 1=1
        <if test="userId != null"> AND user_id = #{userId} </if>
        <if test="actionType != null"> AND action_type = #{actionType} </if>
        <if test="startTime != null"> AND created_at &gt;= #{startTime} </if>
        <if test="endTime != null"> AND created_at &lt;= #{endTime} </if>
        ORDER BY created_at DESC
    </select>

    <select id="countActions" resultType="java.util.Map">
        SELECT action_type, COUNT(*) as cnt
        FROM user_logs
        WHERE created_at BETWEEN #{startTime} AND #{endTime}
        GROUP BY action_type
    </select>


</mapper>
